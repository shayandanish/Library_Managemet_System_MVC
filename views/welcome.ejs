<!DOCTYPE html>
<html>
  <head>
    <title>Library — Welcome</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <!-- Logout button aligned to the top‑right of the page -->
      <div class="d-flex justify-content-end mb-3">
        <form action="/admin/logout" method="POST" class="d-inline">
          <button type="submit" class="btn btn-danger">Logout</button>
        </form>
      </div>

      <div class="text-center mb-4">
        <h1 class="mb-1">Welcome to the AIPS Library Islamabad</h1>
        <p class="text-muted">Quick actions for librarian</p>
        <div class="d-flex justify-content-center gap-3 mt-3">
          <!-- Create new members -->
          <a href="/members/add" class="btn btn-primary btn-lg">Add Member</a>
          <!-- Navigate to books listing -->
          <a href="/books" class="btn btn-outline-secondary btn-lg"
            >View Books</a
          >
          <!-- View all registered members (restored) -->
          <a href="/members/list" class="btn btn-outline-secondary btn-lg"
            >Registered Members</a
          >
        </div>
      </div>

      <div class="d-flex justify-content-center gap-2">
        <!-- Go to Books -->
        <a href="/books/add" class="btn btn-primary">Add Books</a>

        <!-- Issue Book -->
        <button
          class="btn btn-outline-primary"
          data-bs-toggle="modal"
          data-bs-target="#issueModal"
        >
          Issue Book
        </button>

        <!-- Return Book -->
        <button
          class="btn btn-outline-success"
          data-bs-toggle="modal"
          data-bs-target="#returnModal"
        >
          Return Book
        </button>

        <!-- Update Book (NEW) -->
        <button
          class="btn btn-outline-warning"
          data-bs-toggle="modal"
          data-bs-target="#updateModal"
        >
          Update Book
        </button>
      </div>

      <!-- Optional alert if redirected here with a message -->
      <% if (typeof query !== 'undefined' && query.msg) { %>
      <div class="container" style="max-width: 720px">
        <div class="alert alert-info mt-4 mb-0"><%= query.msg %></div>
      </div>
      <% } %>
    </div>

    <!-- Issue Modal -->
    <div class="modal fade" id="issueModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form id="issueForm" class="modal-content" method="POST">
          <div class="modal-header">
            <h5 class="modal-title">Issue a Book</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <label class="form-label">Enter Book ID</label>
            <div class="input-group mb-3">
              <input
                type="text"
                id="issueBookId"
                class="form-control"
                placeholder="AIPSLIB000123 or Mongo _id"
                required
              />
              <button
                type="button"
                class="btn btn-outline-secondary"
                id="checkIssueBtn"
              >
                Check
              </button>
            </div>
            <div id="issueDetails" class="d-none">
              <div class="card">
                <div class="card-body">
                  <h6 id="iTitle" class="card-title mb-1"></h6>
                  <div class="small text-muted mb-2" id="iMeta"></div>
                  <div>
                    Total: <span id="iTotal"></span> | Available:
                    <span id="iAvailable"></span>
                  </div>
                </div>
              </div>
              <div id="issueWarn" class="alert alert-warning mt-2 d-none">
                No copies available.
              </div>
            </div>
            <!-- Member selection for issuing -->
            <div class="mb-3">
              <!-- Search box for finding a member. Typing here will filter the dropdown. -->
              <label for="issueUserSearch" class="form-label"
                >Search Member</label
              >
              <input
                type="text"
                id="issueUserSearch"
                class="form-control mb-2"
                placeholder="Name, ID, email or phone"
              />
              <!-- Dropdown list of members populated by the search -->
              <label for="issueUserSelect" class="form-label"
                >Select Member</label
              >
              <select name="userId" id="issueUserSelect" class="form-select">
                <option value="">-- choose member --</option>
              </select>
            </div>
            <div id="issueError" class="alert alert-danger d-none mt-2"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">
              Cancel
            </button>
            <button
              type="submit"
              id="issueSubmit"
              class="btn btn-primary"
              disabled
            >
              Issue
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Return Modal -->
    <div class="modal fade" id="returnModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form id="returnForm" class="modal-content" method="POST">
          <div class="modal-header">
            <h5 class="modal-title">Return a Book</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <label class="form-label">Enter Book ID</label>
            <div class="input-group mb-3">
              <input
                type="text"
                id="returnBookId"
                class="form-control"
                placeholder="AIPSLIB000123 or Mongo _id"
                required
              />
              <button
                type="button"
                class="btn btn-outline-secondary"
                id="checkReturnBtn"
              >
                Check
              </button>
            </div>
            <div id="returnDetails" class="d-none">
              <div class="card">
                <div class="card-body">
                  <h6 id="rTitle" class="card-title mb-1"></h6>
                  <div class="small text-muted mb-2" id="rMeta"></div>
                  <div>
                    Total: <span id="rTotal"></span> | Available:
                    <span id="rAvailable"></span>
                  </div>
                </div>
              </div>
              <div id="returnWarn" class="alert alert-warning mt-2 d-none">
                All copies already returned.
              </div>
            </div>
            <!-- Member selection for returning -->
            <div class="mb-3">
              <!-- Search box to filter members -->
              <label for="returnUserSearch" class="form-label"
                >Search Member</label
              >
              <input
                type="text"
                id="returnUserSearch"
                class="form-control mb-2"
                placeholder="Name, ID, email or phone"
              />
              <!-- Dropdown list of members to return book -->
              <label for="returnUserSelect" class="form-label"
                >Select Member</label
              >
              <select name="userId" id="returnUserSelect" class="form-select">
                <option value="">-- choose member --</option>
              </select>
            </div>
            <div id="returnError" class="alert alert-danger d-none mt-2"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">
              Cancel
            </button>
            <button
              type="submit"
              id="returnSubmit"
              class="btn btn-success"
              disabled
            >
              Return
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Update Modal (NEW) -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form id="updateForm" class="modal-content" method="POST">
          <div class="modal-header">
            <h5 class="modal-title">Update a Book</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <label class="form-label">Enter Book ID</label>
            <div class="input-group mb-3">
              <input
                type="text"
                id="updateBookId"
                class="form-control"
                placeholder="AIPSLIB000123 or Mongo _id"
                required
              />
              <button
                type="button"
                class="btn btn-outline-secondary"
                id="checkUpdateBtn"
              >
                Check
              </button>
            </div>

            <div id="updateError" class="alert alert-danger d-none"></div>

            <div id="updateFields" class="d-none">
              <div class="mb-2">
                <label class="form-label">Title</label>
                <input
                  type="text"
                  name="title"
                  id="uTitle"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-2">
                <label class="form-label">Author</label>
                <input
                  type="text"
                  name="author"
                  id="uAuthor"
                  class="form-control"
                />
              </div>
              <div class="mb-2">
                <label class="form-label">Category</label>
                <input
                  type="text"
                  name="category"
                  id="uCategory"
                  class="form-control"
                />
              </div>
              <div class="row">
                <div class="col mb-2">
                  <label class="form-label">Year</label>
                  <input
                    type="number"
                    name="year"
                    id="uYear"
                    class="form-control"
                  />
                </div>
                <div class="col mb-2">
                  <label class="form-label">Total Copies</label>
                  <input
                    type="number"
                    name="totalCopies"
                    id="uTotal"
                    class="form-control"
                    min="0"
                  />
                </div>
                <div class="col mb-2">
                  <label class="form-label">Available</label>
                  <input
                    type="number"
                    name="availableCopies"
                    id="uAvailable"
                    class="form-control"
                    min="0"
                  />
                </div>
              </div>
              <div class="row">
                <div class="col mb-2">
                  <label class="form-label">Shelf No</label>
                  <input
                    type="text"
                    name="shelfNo"
                    id="uShelfNo"
                    class="form-control"
                  />
                </div>
                <div class="col mb-2">
                  <label class="form-label">Shelf</label>
                  <input
                    type="text"
                    name="shelf"
                    id="uShelf"
                    class="form-control"
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">
              Cancel
            </button>
            <button
              type="submit"
              id="updateSubmit"
              class="btn btn-warning"
              disabled
            >
              Save changes
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- Common helper ---
      async function lookupBook(id) {
        try {
          const res = await fetch("/books/lookup/" + encodeURIComponent(id));
          if (!res.ok) return null;
          return (await res.json()).data;
        } catch {
          return null;
        }
      }

      // --- Issue ---
      const issueIdInput = document.getElementById("issueBookId");
      const issueBtn = document.getElementById("checkIssueBtn");
      const issueDetails = document.getElementById("issueDetails");
      const issueError = document.getElementById("issueError");
      const issueWarn = document.getElementById("issueWarn");
      const issueSubmit = document.getElementById("issueSubmit");
      const iTitle = document.getElementById("iTitle");
      const iMeta = document.getElementById("iMeta");
      const iTotal = document.getElementById("iTotal");
      const iAvailable = document.getElementById("iAvailable");

      async function doIssueLookup() {
        issueDetails.classList.add("d-none");
        issueError.classList.add("d-none");
        issueWarn.classList.add("d-none");
        issueSubmit.disabled = true;

        const id = issueIdInput.value.trim();
        if (!id) return;

        const data = await lookupBook(id);
        if (!data) {
          issueError.textContent = "Book not found";
          issueError.classList.remove("d-none");
          return;
        }

        iTitle.textContent = data.title || "(Untitled)";
        iMeta.textContent = [data.author, data.category, data.year]
          .filter(Boolean)
          .join(" • ");
        iTotal.textContent = data.total;
        iAvailable.textContent = data.available;
        issueDetails.classList.remove("d-none");

        if (!data.canIssue) {
          issueWarn.classList.remove("d-none");
        } else {
          issueSubmit.disabled = false;
        }
      }

      issueBtn.addEventListener("click", doIssueLookup);
      document
        .getElementById("issueForm")
        .addEventListener("submit", function (e) {
          const id = issueIdInput.value.trim();
          if (!id) return e.preventDefault();
          this.action = "/books/issue/" + encodeURIComponent(id);
        });

      // --- Return ---
      const returnIdInput = document.getElementById("returnBookId");
      const returnBtn = document.getElementById("checkReturnBtn");
      const returnDetails = document.getElementById("returnDetails");
      const returnError = document.getElementById("returnError");
      const returnWarn = document.getElementById("returnWarn");
      const returnSubmit = document.getElementById("returnSubmit");
      const rTitle = document.getElementById("rTitle");
      const rMeta = document.getElementById("rMeta");
      const rTotal = document.getElementById("rTotal");
      const rAvailable = document.getElementById("rAvailable");

      async function doReturnLookup() {
        returnDetails.classList.add("d-none");
        returnError.classList.add("d-none");
        returnWarn.classList.add("d-none");
        returnSubmit.disabled = true;

        const id = returnIdInput.value.trim();
        if (!id) return;

        const data = await lookupBook(id);
        if (!data) {
          returnError.textContent = "Book not found";
          returnError.classList.remove("d-none");
          return;
        }

        rTitle.textContent = data.title || "(Untitled)";
        rMeta.textContent = [data.author, data.category, data.year]
          .filter(Boolean)
          .join(" • ");
        rTotal.textContent = data.total;
        rAvailable.textContent = data.available;
        returnDetails.classList.remove("d-none");

        if (data.available >= data.total) {
          returnWarn.classList.remove("d-none");
        } else {
          returnSubmit.disabled = false;
        }
      }

      returnBtn.addEventListener("click", doReturnLookup);
      document
        .getElementById("returnForm")
        .addEventListener("submit", function (e) {
          const id = returnIdInput.value.trim();
          if (!id) return e.preventDefault();
          this.action = "/books/return/" + encodeURIComponent(id);
        });

      // --- Update (NEW) ---
      const updateIdInput = document.getElementById("updateBookId");
      const checkUpdateBtn = document.getElementById("checkUpdateBtn");
      const updateError = document.getElementById("updateError");
      const updateFields = document.getElementById("updateFields");
      const updateSubmit = document.getElementById("updateSubmit");
      const uTitle = document.getElementById("uTitle");
      const uAuthor = document.getElementById("uAuthor");
      const uCategory = document.getElementById("uCategory");
      const uYear = document.getElementById("uYear");
      const uTotal = document.getElementById("uTotal");
      const uAvailable = document.getElementById("uAvailable");
      const uShelfNo = document.getElementById("uShelfNo");
      const uShelf = document.getElementById("uShelf");

      async function doUpdateLookup() {
        updateFields.classList.add("d-none");
        updateError.classList.add("d-none");
        updateSubmit.disabled = true;

        const id = updateIdInput.value.trim();
        if (!id) return;

        const data = await lookupBook(id);
        if (!data) {
          updateError.textContent = "Book not found";
          updateError.classList.remove("d-none");
          return;
        }

        // Prefill
        uTitle.value = data.title || "";
        uAuthor.value = data.author || "";
        uCategory.value = data.category || "";
        uYear.value = data.year || "";
        uTotal.value = data.total ?? data.totalCopies ?? 0;
        uAvailable.value =
          data.available ?? data.availableCopies ?? (uTotal.value || 0);
        uShelfNo.value = data.shelfNo || "";
        uShelf.value = data.shelf || "";

        updateFields.classList.remove("d-none");
        updateSubmit.disabled = false;

        // Set form action to your update route
        document.getElementById("updateForm").action =
          "/books/update/" + encodeURIComponent(id);
      }

      checkUpdateBtn.addEventListener("click", doUpdateLookup);
    </script>

    <script>
      async function loadMembers(
        selectId,
        { q = "", type = "", gender = "" } = {}
      ) {
        const params = new URLSearchParams();
        if (q) params.set("q", q);
        if (type) params.set("type", type);
        if (gender) params.set("gender", gender);

        const res = await fetch("/members?" + params.toString());
        const users = await res.json();
        const sel = document.getElementById(selectId);
        sel.innerHTML = '<option value="">-- choose member --</option>';
        users.forEach((u) => {
          const opt = document.createElement("option");
          opt.value = u._id;
          opt.textContent = `${u.fullName} (${u.memberID}) — ${u.memberType}`;
          sel.appendChild(opt);
        });
      }

      document
        .getElementById("issueModal")
        ?.addEventListener("show.bs.modal", () => {
          loadMembers("issueUserSelect");
        });
      document
        .getElementById("returnModal")
        ?.addEventListener("show.bs.modal", () => {
          loadMembers("returnUserSelect");
        });

      // When searching in the issue modal, filter the members list
      document
        .getElementById("issueUserSearch")
        ?.addEventListener("input", (ev) => {
          const q = ev.target.value || "";
          loadMembers("issueUserSelect", { q });
        });

      // When searching in the return modal, filter the members list
      document
        .getElementById("returnUserSearch")
        ?.addEventListener("input", (ev) => {
          const q = ev.target.value || "";
          loadMembers("returnUserSelect", { q });
        });
    </script>
  </body>
</html>
